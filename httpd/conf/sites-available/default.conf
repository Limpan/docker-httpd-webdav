<VirtualHost *:80>
  ServerName localhost
  DocumentRoot /var/www/html/

  DirectoryIndex index.php index.html
  IndexIgnore .DAV

  CustomLog /proc/self/fd/1 combined
  ErrorLog /proc/self/fd/2

  <Directory /var/www/html/>
    Require all granted
  </Directory>

  <DirectoryMatch "^/.*/\.git/">
    Require all denied
  </DirectoryMatch>

  Alias /dav /var/lib/dav/data/

  <Directory /var/lib/dav/data/>
    Dav On
    Options Indexes FollowSymLinks
    AllowOverride All

    AuthType Basic
    AuthName "WebDAV"
    AuthUserFile /user.passwd
    <RequireAny>
      Require valid-user
      Require method HEAD GET POST CONNECT PUT DELETE OPTIONS PROPFIND PROPPATCH MKCOL COPY MOVE LOCK UNLOCK TRACE
    </RequireAny>
  </Directory>

  <FilesMatch \.php$>
    SetHandler "proxy:fcgi://php:9000"
  </FilesMatch>

  <Location /dav>
    DirectoryIndex disabled
    AllowOverride none

    SetHandler default_handler
    Require valid-user
  </Location>

#  <LocationMatch ^\/~[^\/]+>
#    AllowOverride All
#  </LocationMatch>

  RewriteEngine On

  RewriteCond %{REQUEST_URI} ^/dav/
  RewriteRule ^/dav/(.*?)$ /var/lib/dav/data/%{LA-U:REMOTE_USER}/$1 [L]

  RewriteCond %{REQUEST_URI} ^/~
  RewriteRule ^/~([^/]+)/?(.*) /var/lib/dav/data/$1/$2 [L]

  RequestHeader edit Destination ^https http early

#  ProxyPassMatch ^(?!/dav)/(.*\.php(/.*)?)$ fcgi://php:9000/var/www/html/$1
</VirtualHost>
